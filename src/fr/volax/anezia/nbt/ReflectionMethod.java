package fr.volax.anezia.nbt;

import java.lang.reflect.Method;

import fr.volax.anezia.nbt.utils.MinecraftVersion;
import org.bukkit.inventory.ItemStack;

public enum ReflectionMethod {
    COMPOUND_SET_INT(ClassWrapper.NMS_NBTTAGCOMPOUND.getClazz(), new Class[]{String.class, int.class}, MinecraftVersion.MC1_7_R4, new Since[]{new Since(MinecraftVersion.MC1_7_R4, "setInt")}),
    COMPOUND_GET_INT(ClassWrapper.NMS_NBTTAGCOMPOUND.getClazz(), new Class[]{String.class}, MinecraftVersion.MC1_7_R4, new Since[]{new Since(MinecraftVersion.MC1_7_R4, "getInt")}),
    COMPOUND_HAS_KEY(ClassWrapper.NMS_NBTTAGCOMPOUND.getClazz(), new Class[]{String.class}, MinecraftVersion.MC1_7_R4, new Since[]{new Since(MinecraftVersion.MC1_7_R4, "hasKey")}),
    COMPOUND_REMOVE_KEY(ClassWrapper.NMS_NBTTAGCOMPOUND.getClazz(), new Class[]{String.class}, MinecraftVersion.MC1_7_R4, new Since[]{new Since(MinecraftVersion.MC1_7_R4, "remove")}),
    COMPOUND_GET_TYPE(ClassWrapper.NMS_NBTTAGCOMPOUND.getClazz(), new Class[]{String.class}, MinecraftVersion.MC1_8_R3, new Since[]{new Since(MinecraftVersion.MC1_8_R3, "b"), new Since(MinecraftVersion.MC1_9_R1, "d")}),
    COMPOUND_GET_KEYS(ClassWrapper.NMS_NBTTAGCOMPOUND.getClazz(), new Class[0], MinecraftVersion.MC1_7_R4, new Since[]{new Since(MinecraftVersion.MC1_7_R4, "c"), new Since(MinecraftVersion.MC1_13_R1, "getKeys")}),
    ITEMSTACK_SET_TAG(ClassWrapper.NMS_ITEMSTACK.getClazz(), new Class[]{ClassWrapper.NMS_NBTTAGCOMPOUND.getClazz()}, MinecraftVersion.MC1_7_R4, new Since[]{new Since(MinecraftVersion.MC1_7_R4, "setTag")}),
    ITEMSTACK_NMSCOPY(ClassWrapper.CRAFT_ITEMSTACK.getClazz(), new Class[]{ItemStack.class}, MinecraftVersion.MC1_7_R4, new Since[]{new Since(MinecraftVersion.MC1_7_R4, "asNMSCopy")}),
    ITEMSTACK_BUKKITMIRROR(ClassWrapper.CRAFT_ITEMSTACK.getClazz(), new Class[]{ClassWrapper.NMS_ITEMSTACK.getClazz()}, MinecraftVersion.MC1_7_R4, new Since[]{new Since(MinecraftVersion.MC1_7_R4, "asCraftMirror")});

    private Method method;

    ReflectionMethod(Class<?> targetClass, Class<?>[] args, MinecraftVersion addedSince, Since... methodnames) {
        MinecraftVersion server = MinecraftVersion.getVersion();
        if (server.compareTo(addedSince) < 0)
            return;
        Since target = methodnames[0];
        for (Since s : methodnames) {
            if (s.version.getVersionId() <= server.getVersionId() && target.version.getVersionId() < s.version.getVersionId())
                target = s;
        }
        Since targetVersion = target;
        try {
            this.method = targetClass.getMethod(targetVersion.name, args);
            this.method.setAccessible(true);
        } catch (NullPointerException | NoSuchMethodException | SecurityException ex) {
            ex.printStackTrace();
        }
    }

    public Object run(Object target, Object... args) {
        try {
            return this.method.invoke(target, args);
        } catch (Exception ex) {
            ex.printStackTrace();
            return null;
        }
    }

    public static class Since {
        final MinecraftVersion version;

        final String name;

        Since(MinecraftVersion version, String name) {
            this.version = version;
            this.name = name;
        }
    }
}